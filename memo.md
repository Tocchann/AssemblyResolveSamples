# プラットフォーム依存アセンブリを動的にロードしてみた！

## アジェンダ
- はじめに
- .NET アプリがアセンブリを読み込むタイミング
- .NET で動的にアセンブリを読み込む簡単な方法
- 動作中のモードに沿ったプラットフォームの選択方法
- ビルド時に適切なバイナリを適切な場所に配置する方法
- まとめ

## はじめに

### 今回のプロジェクト構成

| ProjectName | Language | Type | Framework | Version | Any CPU | ARM | ARM64 | Win32 | x64 |
|---|---|---|---|---|---|---|---|---|---|
| AssemblyResolveLoader | C# | dll | .NET Standard | 2.0 | ○ | × |× |× |× |
| ConsoleAppCore | C# | exe | .NET | 6 | ○ | × |× |× |× |
| ConsoleAppNetfx | C# | exe | .NET Framework | 4.8.1 | ○ | × |× |× |× |
| CppCliDll | C++/CLI | dll | .NET Framework | 4.8.1 | × | × | ○ | ○ | ○ | 
| CppCliDllCore | C++/CLI | dll | .NET | 6 | × | ○ | ○ | ○ | ○ | 

## .NET アプリがアセンブリを読み込むタイミング

- .NET アプリは、そのメソッドが呼ばれるタイミングではじめてロードされる
    - 呼び出そうとするまでロードされない
- 実際に見てみましょう！

## .NET で動的にアセンブリを読み込む簡単な方法

- アセンブリを動的に選択するにはどうすればいいか？
    - AppDomain.AssemblyResolve イベントを利用する
        - ロードしようとしたアセンブリが見つからない時に呼ばれるイベント
    - 実行状況(RuntimeInformation.ProcessArchitecture)を見てロード対象を決める
        - アプリケーション構築時に配置構成を決めておく必要がある

## 動作中のモードに沿ったプラットフォームの選択方法

適切なプラットフォームを選択するにはどうするか？

1. RuntimeInformation.ProcessArchitecture を参照
    - ARMも含めた判定が可能
2. IntPtr.Size で判定する
    - 32bitプロセスか、64bitプロセスかしかわからない

## ビルド時に適切なバイナリを適切な場所に配置する方法

1. 参照アセンブリをローカルにコピーしない(オプションで必ず設定しておく)
2. MSBuild ビルドの Target で簡単にコピーできるようにアセンブリを事前配置する
3. プロジェクトを拡張して、実際に利用するアセンブリをコピーするTarget(コマンド処理)を追加する

## まとめ

今更だけど、まだまだ使いたい動的なアセンブリのロード振り分け。いかがだったでしょうか？

今回は C++/CLI を対象にしていますが、C#のアセンブリでも基本的には同様です。
